var materialClass="pure-material-checkbox";(-1<navigator.userAgent.indexOf("MSIE ")||-1<navigator.userAgent.indexOf("Trident/"))&&(materialClass="");var eventMap,i18n,isEventsPage=!1,isEventsFrontPage=!1,isEnglish=!1,eventTags=[],eventLocations=[],allEvents=[],filteredEvents=[],lang="fi",libraryList=[],faPath="https://keski-finna.fi/external/finna/style/fa/svgs/solid/",eventCacheStamp=localStorage.getItem("keskiEventsTimestamp"),libraryListCache=localStorage.getItem("keskiLibraries"),cityListCache=localStorage.getItem("cityList");function checkEventsCache(){$.getJSON("https://keski-finna.fi/wp-json/acf/v3/cache",function(a){var b=a[0].acf.events_stamp;if(eventCacheStamp=localStorage.getItem("keskiEventsTimestamp"),eventCacheStamp===b){var c=localStorage.getItem("keskiEvents");null===c?(localStorage.setItem("keskiEventsTimestamp",b),fetchEvents()):generateEventList(JSON.parse(c))}else localStorage.setItem("keskiEventsTimestamp",b),fetchEvents()})}function fetchConsortiumLibraries(a){var b=jQuery.Deferred();return setTimeout(function(){null!==libraryListCache&&(libraryList=JSON.parse(libraryListCache),b.resolve()),$.getJSON("https://api.kirjastot.fi/v4/library?lang="+lang+"&consortium="+a+"&limit=1500",function(a){for(var c=0;c<a.items.length;c++)libraryList.push({id:a.items[c].id,text:a.items[c].name,city:a.items[c].city.toString(),street:a.items[c].address.street,zipcode:a.items[c].address.zipcode,coordinates:a.items[c].coordinates,services:JSON.stringify(a.items[c].services)}),85449==a.items[c].id&&libraryList.push({id:a.items[c].id,text:a.items[c].name,city:"16055",street:a.items[c].address.street,zipcode:a.items[c].address.zipcode,coordinates:a.items[c].coordinates,services:JSON.stringify(a.items[c].services)});localStorage.setItem("keskiLibraries",JSON.stringify(libraryList)),b.resolve()})},1),b.promise()}function addTagToTagArray(a){for(var b=!1,c=0;c<eventTags.length;c++)eventTags[c].id==a.id&&(++eventTags[c].count,b=!0);b||eventTags.push({id:a.id,nameFi:a.fi,nameEn:a.en,count:1})}function addLocationsToLocationArray(a){for(var b=!1,c=0;c<eventLocations.length;c++)eventLocations[c].id==a&&(++eventLocations[c].count,b=!0);b||eventLocations.push({id:a,count:1})}var checkedTags=[],checkedLocations=[];function locationExists(a){return filteredEvents.some(function(b){return b.city==a})}function tagExists(a){return filteredEvents.some(function(b){return b.tags==a})}function filterEvents(a){filteredEvents=[];for(var b=0;b<allEvents.length;b++){var c=!0,d=!0;0!==checkedTags.length&&(c=checkedTags.some(function(a){return allEvents[b].tags.includes(a)})),0!==checkedLocations.length&&(d=checkedLocations.some(function(a){return allEvents[b].city.includes(a)})),c&&d?(filteredEvents.push(allEvents[b]),$("#event-"+allEvents[b].id).removeClass("hidden-event")):$("#event-"+allEvents[b].id).addClass("hidden-event")}0===filteredEvents.length?$(".no-matching-events").css("display","block"):$(".no-matching-events").css("display","none"),a?$.each($(".location-checkbox-container"),function(){var a=$(this)[0].id,b=a.replace("location_",""),c=locationExists(b)}):$.each($(".tag-checkbox-container"),function(){var a=$(this)[0].id,b=a.replace("tag_",""),c=tagExists(b);c&&$(this).removeClass("hidden-filter")}),$(".events-section-title").replaceWith("<h1 class=\"events-page-title events-section-title\">"+i18n.get("Events")+" <span class=\"events-count-small\"> ("+filteredEvents.length+")</span></h1>")}function bindFilterEvents(){$("input[name=\"tags\"]").change(function(){checkedTags=[],$.each($("input[name='tags']:checked"),function(){checkedTags.push(parseInt($(this).val()))}),filterEvents(!0)}),$("input[name=\"location\"]").change(function(){checkedLocations=[],$.each($("input[name='location']:checked"),function(){checkedLocations.push($(this).val())}),filterEvents()}),800<window.innerWidth&&$("#toggleEventFilters").click()}function fetchEvents(){$.ajax("https://keski-finna.fi/wp-json/acf/v3/events?per_page=500",{accepts:{xml:"application/json"},dataType:"json",success:function(a){localStorage.setItem("keskiEvents",JSON.stringify(a)),generateEventList(a),checkEventsCache()},error:function(a,b,c){console.log(c)},complete:function(){}})}function generateTags(a){for(var b,c="",d=[],e=0;e<a.length;e++)if(b=JSON.parse(a[e]),d.push(b.id),addTagToTagArray(b),!isEnglish){var f=", ";e==a.length-1||1==a.length?f="":e==a.length-2&&(f=" & ");var g=b.fi;0!=e&&(g=g.toLowerCase()),c=c+g+f}else c=c+b.en+". ";return c="<span class=\"event-detail event-tags\" aria-label=\""+i18n.get("Event category")+"\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Event category")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"tags.svg\" class=\"fa-svg event-details-icon\">"+c+"</span>",{tagList:d,tagDisplay:c}}function generateEventTimeDisplay(a,b){var c=a.substr(0,10),d=a.slice(-5);"00.00"===d&&(d=null);var e=null,f=null;null!==b&&""!==b&&(e=b.substr(0,10),"00.00"!=b.slice(-5)&&(f=b.slice(-5)));var g=!0;null!==e&&e!=c&&(g=!1);var h=!1,i="<img alt=\"\" src=\""+faPath+"calendar.svg\" class=\"fa-svg event-details-icon\"> "+c;null!=d&&(i=i+"<img alt=\"\" src=\""+faPath+"clock.svg\" class=\"fa-svg event-details-icon event-li-clock\"> "+d);var j="";null==e?i+=i18n.get("Starting"):g&&null!=f?j=f:g&&null==f?(j="",i+=i18n.get("Starting")):g||null!=f?!g&&null!=f&&(j="<img alt=\"\" src=\""+faPath+"calendar.svg\" class=\"fa-svg event-details-icon\"> "+e,j=j+"<img alt=\"\" src=\""+faPath+"clock.svg\" class=\"fa-svg event-details-icon event-li-clock\"> "+f,h=!0):j=e;var k="";return""!==j&&(k="<i class=\"start-end-divider\"> \u2013 </i>"),h&&(i="<span class=\"event-time-row event-start-row\">"+i+k+"</span>",j="<span class=\"event-time-row event-end-row\">"+j+"</span>",k=""),"<div class=\"event-date-container\">"+i+k+j+"</div>"}function generateEventItem(a,b){function c(a,b,c,d){var e=b+", "+d+"::"+a.lat+", "+a.lon,f=i18n.get("Route and transportation");return e="https://opas.matka.fi/reitti/POS/"+e,e=encodeURI(e),"Jyv\xE4skyl\xE4"!==d&&(e="https://www.google.com",!isEnglish&&(e="https://www.google.fi"),e+="/maps/dir//",e=e+b+", "+c+", "+d+"/@"+a.lat+", "+a.lon+", 15z/",f=i18n.get("Navigation to location")),"<a target=\"_blank\" class=\"external-navigation-link\" href=\""+e+"\">"+f+"</a>"}var d=[],f=[],g="",h="",j=[],k="";0!==a.tags.length&&(d=generateTags(a.tags),k=d.tagDisplay,f=d.tagList);var l=generateEventTimeDisplay(a.start_date,a.end_date),m="";!1==a.image&&(a.image="https://keski-finna.fi/wp-content/uploads/paakirjasto59_YouTube_820x461_acf_cropped.jpg"),null!==a.image&&!1!==a.image&&(m="<img class=\"event-image\" loading=\"lazy\" alt=\"\" src=\""+a.image+"\">");var n=a.title;isEnglish&&null!==a.english_title&&""!=a.english_title&&(n=a.english_title);var o=a.content;isEnglish&&null!==a.english_content&&""!=a.english_content&&(o=a.english_content);var h="",p="",q=[];if(a.custom_address){var r=a.custom_address,s=r.street_name,t=r.street_number,u=r.post_code,v=r.city;v==null&&(v=r.state),j.push(v);var w=r.name;if(w==null)w="";else{var y=w.slice(0,4),z=s.slice(0,4);y==z&&(w=w+", "+v)}p=w;var A={lat:r.lat,lon:r.lng},B=s+" "+t;t==null&&(B=s);var C={street:B,zipcode:u};q.push({location:w,coordinates:A,city:v,address:C})}for(var D,E=0;E<a.organizer.length;E++){D=!1;for(var F=0;F<libraryList.length;F++)if(a.organizer[E]==libraryList[F].id){var B=libraryList[F].street,G=libraryList[F].zipcode,H=libraryList[F].city,I={street:B,zipcode:G};a.organizer[E]={location:libraryList[F].text,coordinates:libraryList[F].coordinates,city:H,address:I},j.push(libraryList[F].city),D=!0}D||(0==a.organizer[E]?(a.organizer[E]={location:i18n.get("Other location"),coordinates:null,city:null},j.push(i18n.get("Other location"))):1==a.organizer[E]?(a.organizer[E]={location:i18n.get("Keski Libraries"),coordinates:null,city:null},j.push(i18n.get("Keski Libraries"))):2==a.organizer[E]&&(a.organizer[E]={location:i18n.get("Web event"),coordinates:null,city:null},j.push(i18n.get("Web event"))))}h=1<a.organizer.length?a.organizer.length+" "+i18n.get("event locations"):void 0===a.organizer[0]?i18n.get("Other location"):a.organizer[0].location,""!=a.price&&(g=a.price+" \u20AC",g="<span class=\"event-detail event-price\" aria-label=\""+i18n.get("Price")+"\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Price")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"money-bill-alt.svg\" class=\"fa-svg event-details-icon\">"+g+"</span>");var J="";if(null!==a.link_url&&""!=a.link_url){var K=generatePrettyUrl(a.link_url);J="<span class=\"event-detail event-link\" aria-label=\""+i18n.get("Website")+"\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Website")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"globe.svg\" class=\"fa-svg event-details-icon\"><a href=\""+a.link_url+"\">"+K+"</a></span>"}var M=a.organizer;""!==p&&(h=p,M=q);var N="";if(1==M.length){var O=M[0];null!=O.address&&null!=O.city&&null!=O.coordinates&&(N=c(O.coordinates,O.address.street,O.address.zipcode,O.city))}""!=N&&(N="<span class=\"event-detail event-transit\" aria-label=\""+i18n.get("Navigation to location")+"\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Navigation to location")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"directions.svg\" class=\"fa-svg event-details-icon\">"+N+"</span>");var P="",Q="";""!=a.location_info&&a.location_info!=null&&""==Q&&(Q=a.location_info,"."!=Q.charAt(Q.length-1)&&(Q+=".")),""!==Q&&(P="<span class=\"event-detail event-location-info\" aria-label=\""+i18n.get("Location information")+"\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Location information")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"location-arrow.svg\" class=\"fa-svg event-details-icon\">"+Q+"</span>"),o="<div class=\"event-content\"><div class=\"event-modal-description\">"+o+"<div class=\"event-info-box\">"+k+g+J+"</div></div></div>";var R="";isEventsFrontPage&&(R="front-page-event");var S=i18n.get("Read")+": "+n.replace(/&quot;/g,"")+" "+a.start_date.replace("00.00","");M=JSON.stringify(M);var T="<li class=\"event-li "+R+"\" id=\"event-"+b+"\"><a class=\"event-item-link\" href=\"javascript:void(0);\"  title=\""+S+"\" data-url=\""+a.perma_link+"\"data-image='"+m+"' data-name='"+n+"' data-time='"+l+"' data-message='"+o+"' data-location-text='"+h+"' data-location='"+M+"' data-location-info='"+P+"' data-transit='"+N+"'><div class=\"event-li-img\" style=\"height: 100%; width: auto;\">"+m+"</div><div class=\"event-li-details\"><span class=\"event-li-title\">"+n+"</span>"+l+"<span class=\"event-li-place\"><img alt=\"\" src=\""+faPath+"map-marker-alt.svg\" class=\"fa-svg event-li-icon\">"+h+"</span></div></a></li>";$("#keskiEventsUl").append(T),j=$.unique(j);for(var U=0;U<j.length;U++)addLocationsToLocationArray(j[U]);allEvents.push({id:b,tags:f,city:j,url:a.perma_link}),isFrontPage||$(".events-section-title").replaceWith("<h1 class=\"events-page-title events-section-title\">"+i18n.get("Events")+" <span class=\"events-count-small\"> ("+allEvents.length+")</span></h1>")}function formatEventTimeToDate(a){var b=a.substr(0,10),c=a.slice(-5),d=b.substr(0,2),e=b.substr(3,2),f=b.substr(6,4),g=c.substr(0,2),h=c.substr(3,2),i=new Date;return i.setDate(d),i.setMonth(e-1),i.setYear(f),i.setHours(g),i.setMinutes(h),i.setSeconds(0),i}function generateFilters(){isEnglish?eventTags.sort(function(c,a){return c.nameEn.localeCompare(a.nameEn)}):eventTags.sort(function(c,a){return c.nameFi.localeCompare(a.nameFi,"fi",{sensitivity:"base"})});for(var a=0;a<eventTags.length;a++){var b=eventTags[a].id,c=eventTags[a].nameFi;isEnglish&&(c=eventTags[a].nameEn),$("#categoryFiltersContent").append("<div id=\"tag_"+b+"\" class=\"tag-checkbox-container\"><label class=\""+materialClass+"\"><input type=\"checkbox\" name=\"tags\" value=\""+b+"\"><span>"+c+"</span></label></div>")}eventLocations.sort(function(c,a){return c.id.localeCompare(a.id,"fi",{sensitivity:"base"})});for(var d,e=0;e<eventLocations.length;e++)d=eventLocations[e].id,$("#locationFiltersContent").append("<div id=\"location_"+d+"\" class=\"location-checkbox-container\"><label class=\""+materialClass+"\"><input id=\""+d+"\" type=\"checkbox\" name=\"location\" value=\""+d+"\"><span>"+d+"</span></label></div>");if(bindFilterEvents(),$("#keskiEvents .loader").css("display","none"),800<window.innerWidth){var f=$(".event-location-filter").innerHeight()+$(".event-category-filter").innerHeight()+500;$(".event-filters").css("margin-bottom",f+"px"),$(".event-filters .collapsed").click(),$(".events-page").css("min-height",f+"px")}$(".event-filters").css("visibility","visible")}function bindEventListEvents(){$(".event-item-link").on("click",function(){var a=$(this).data("name"),b=$(this).data("time"),c=$(this).data("message"),d=$(this).data("location-text"),e=$(this).data("location"),f=$(this).data("location-info"),g=$(this).data("transit"),h=$(this).data("image");c=c.replace(/^(&nbsp;)+/g,""),c=c.replace(/(<p>&nbsp;<\/p>)+/g,""),c=c.replace(/(<p><\/p>)+/g,""),c=c.replace(/(<p>\s<\/p>)+/g,"");var i="<span class=\"event-detail event-location\" aria-label=\"Location\"><img data-toggle=\"tooltip\" title=\""+i18n.get("Location")+"\" data-placement=\"top\" alt=\"\" src=\""+faPath+"map-marker-alt.svg\" class=\"fa-svg event-details-icon\">"+d+"</span>";$(".event-modal-header-text").replaceWith("<div class=\"event-modal-header-text\"><h1 class=\"modal-title\" id=\"eventModalTitle\">"+a+"</h1>"+b+"</div>"),$("#eventDescription").replaceWith("<div id=\"eventDescription\"><div> <div class=\"feed-content\"><div class=\"holder\">"+c+"</div></div></div></div>"),$("#mapRow").css("display","block"),$(".event-location-info-box").replaceWith("<div class=\"event-info-box event-location-info-box\">"+i+f+g+"</div>"),asyncGenerateEventMap(e),$("#eventImageContainer").html("<div id=\"eventImageContainer\">"+h+"</div>"),$("#eventModal").modal("show");var j=$(this).data("url").toString(),k=window.location.href.toString();if(-1===k.indexOf(j)){j=k+"?event="+j;var l={urlValue:j};history.replaceState(l,a,j)}});var a=window.location.href;if(a=decodeVal(a),-1<a.indexOf("?event="))for(var b,c=new RegExp(/\?event=.*/g),d=a.match(c)[0],e=0;e<allEvents.length;e++)if(b="?event="+allEvents[e].url,d===b){var f=allEvents[e].url;setTimeout(function(){$("[data-url=\""+f+"\"]").click()},1400)}$("#eventModal").on("hide.bs.modal",function(){var a=window.location.href;if(a.indexOf("?event=")){var b=new RegExp(/\?event=.*/g);a=a.replace(b,"");var c={urlValue:a};history.replaceState(c,"",a)}})}var eventsGenerated=!1;function generateEventList(a){if(!eventsGenerated){eventsGenerated=!0,a.sort(function(c,a){var b=formatEventTimeToDate(c.acf.start_date),d=formatEventTimeToDate(a.acf.start_date);return b-d});var b=a.length;isEventsFrontPage&&(b=4,767<window.innerWidth&&(b=6));for(var c=0;c<b;c++)if(b!==a.length){var d=a[c].acf.start_date;d=moment(d,"DD.MM.YYYY");var e=d._d;e.setDate(e.getDate()+2);var f=new Date;e<f?++b:generateEventItem(a[c].acf,a[c].id)}else generateEventItem(a[c].acf,a[c].id);bindEventListEvents(),generateFilters()}}var eventMap,layerGroup=null;function addCoordinateToMap(a){var b="",c="",d="",e=a.location;a.address==null?e="<strong>"+a.location+"</strong><br>":(a.address.street!=null&&(c=a.address.street),a.address.zipcode!=null&&(d=a.address.zipcode),e=-1<e.indexOf(a.address.street)?"":"<strong>"+a.location+"</strong><br>"),b=e+c+", <br>"+d+", "+a.city;var f=L.divIcon({html:"<img data-toggle=\"tooltip\" title=\""+i18n.get("Event location")+"\" alt=\"\" src=\""+faPath+"book-reader.svg\" class=\"fa-svg fa-leaflet-map-marker\">",iconSize:[24,24],popupAnchor:[0,3],className:"event-map-marker"});null!=a.coordinates&&L.marker([a.coordinates.lat,a.coordinates.lon],{icon:f}).addTo(layerGroup).bindPopup(b,{autoClose:!1,autoPan:!1}).openPopup()}function addCoordinatesToMap(a){var b=jQuery.Deferred();return setTimeout(function(){if(0!==a.length)for(var c=null,d=0,e=0;e<a.length;e++){if(null==a[e].coordinates){if(1==a.length)return $("#mapRow").css("display","none"),void b.resolve();++d}else addCoordinateToMap(a[e]),++d;if(d===a.length)try{c=null==a[e].coordinates?{lat:a[e-1].coordinates.lat,lon:a[e-1].coordinates.lon}:{lat:a[e].coordinates.lat,lon:a[e].coordinates.lon},eventMap.whenReady(function(){setTimeout(function(){eventMap.invalidateSize();var b=12;1<a.length&&(b=9.5),eventMap.setView([c.lat,c.lon],b),layerGroup.eachLayer(function(a){a.openPopup()})},250)}),b.resolve()}catch(a){console.log(a),$("#mapRow").css("display","none"),b.resolve()}}},1),b.promise()}function asyncGenerateEventMap(a){var b=jQuery.Deferred();return setTimeout(function(){eventMap?layerGroup.clearLayers():(eventMap=L.map("eventMapContainer"),L.tileLayer.fallback("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(eventMap),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png").addTo(eventMap),eventMap.options.minZoom=6,eventMap.options.maxZoom=18,eventMap.setView(["62.750","25.700"],10.5),layerGroup=L.layerGroup().addTo(eventMap),$(".leaflet-control-attribution").replaceWith("<div class=\"leaflet-control-attribution leaflet-control\">\xA9 <a target=\"_blank\" href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> | <a target=\"_blank\" href=\"https://carto.com/attributions\">CARTO</a></div>")),$.when(addCoordinatesToMap(a)).then(function(){b.resolve()})},1),b.promise()}function asyncReplaceIdWithCity(a){var b=jQuery.Deferred();return setTimeout(function(){try{for(var c=0,d=0;d<a.items.length;d++){for(var e=0;e<libraryList.length;e++)libraryList[e].city==a.items[d].id.toString()&&(libraryList[e].city=a.items[d].name);++c,c===a.items.length&&(libraryList.sort(function(c,a){return c.city<a.city?-1:c.city>a.city?1:0}),b.resolve())}}catch(a){console.log("Error in fetching cities: "+a)}},1),b.promise()}function asyncFetchCityList(){var a=jQuery.Deferred();return setTimeout(function(){try{null===cityListCache?$.getJSON("https://api.kirjastot.fi/v4/city?lang=fi&limit=1500",function(b){localStorage.setItem("cityList",JSON.stringify(b)),asyncReplaceIdWithCity(b),a.resolve()}):(asyncReplaceIdWithCity(JSON.parse(cityListCache)),a.resolve())}catch(a){console.log("Error in fetching cities: "+a)}},1),a.promise()}$(document).ready(function(){"en-gb"==document.documentElement.lang&&(isEnglish=!0),isEventsPage=1===$(".events-page").length,isEventsFrontPage=1===$(".events-front-page").length,(isEventsPage||isEventsFrontPage)&&$.when(fetchConsortiumLibraries(2113)).then(function(){$.when(asyncFetchCityList()).then(function(){null===eventCacheStamp?fetchEvents():checkEventsCache(),isEventsFrontPage?($(".events-section-title").text(i18n.get("Events")),$(".events-front-page-nav-button").text(i18n.get("More events")),$(".events-front-page-nav-button").css("visibility","visible")):($(".no-matching-events-div").text(i18n.get("No matching events")),$(".sr-event-filters-title").text(i18n.get("Filter events")),$("#toggleEventFilters").text(i18n.get("Filter events")),$(".event-category-filter-title").text(i18n.get("Category")),$(".event-location-filter-title").text(i18n.get("Location"))),$(".close-event-modal").text(i18n.get("Close"))})})});
