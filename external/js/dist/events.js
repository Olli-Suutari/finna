"use strict";var e="pure-material-checkbox";(navigator.userAgent.indexOf("MSIE ")>-1||navigator.userAgent.indexOf("Trident/")>-1)&&(e="");var t,a=!1,n=!1,i=!1,s=[],o=[],l=[],r=[],c=[],v="https://keski-finna.fi/external/finna/style/fa/svgs/solid/",d=localStorage.getItem("keskiEventsTimestamp"),g=localStorage.getItem("keskiLibraries"),p=localStorage.getItem("cityList");function u(){$.getJSON("https://keski-finna.fi/wp-json/acf/v3/cache",(function(e){var t=e[0].acf.events_stamp;if((d=localStorage.getItem("keskiEventsTimestamp"))===t){var a=localStorage.getItem("keskiEvents");null!==a?O(JSON.parse(a)):(localStorage.setItem("keskiEventsTimestamp",t),b())}else localStorage.setItem("keskiEventsTimestamp",t),b()}))}function f(e){for(var t=!1,a=0;a<s.length;a++)s[a].id==e.id&&(s[a].count=s[a].count+1,t=!0);t||s.push({id:e.id,nameFi:e.fi,nameEn:e.en,count:1})}function m(e){for(var t=!1,a=0;a<o.length;a++)o[a].id==e&&(o[a].count=o[a].count+1,t=!0);t||o.push({id:e,count:1})}var h=[],y=[];function k(e){r=[];for(var a=0;a<l.length;a++){var n=!0,i=!0;0!==h.length&&(n=h.some((function(e){return l[a].tags.includes(e)}))),0!==y.length&&(i=y.some((function(e){return l[a].city.includes(e)}))),n&&i?(r.push(l[a]),$("#event-"+l[a].id).removeClass("hidden-event")):$("#event-"+l[a].id).addClass("hidden-event")}0===r.length?$(".no-matching-events").css("display","block"):$(".no-matching-events").css("display","none"),e?$.each($(".location-checkbox-container"),(function(){var e,t=$(this)[0].id.replace("location_","");e=t,r.some((function(t){return t.city==e}))})):$.each($(".tag-checkbox-container"),(function(){var e,t=$(this)[0].id.replace("tag_","");(e=t,r.some((function(t){return t.tags==e})))&&$(this).removeClass("hidden-filter")})),$(".events-section-title").replaceWith('<h1 class="events-page-title events-section-title">'+t.get("Events")+' <span class="events-count-small"> ('+r.length+")</span></h1>")}function b(){$.ajax("https://keski-finna.fi/wp-json/acf/v3/events?per_page=500",{accepts:{xml:"application/json"},dataType:"json",success:function(e){localStorage.setItem("keskiEvents",JSON.stringify(e)),O(e),u()},error:function(e,t,a){console.log(a)},complete:function(){}})}function w(e,a){var s=[],o=[],r="",d="",g=[],p="";0!==e.tags.length&&(s=function(e){for(var a="",n=[],s=0;s<e.length;s++){var o=JSON.parse(e[s]);if(n.push(o.id),f(o),i)a=a+o.en+". ";else{var l=", ";s==e.length-1||1==e.length?l="":s==e.length-2&&(l=" & ");var r=o.fi;0!=s&&(r=r.toLowerCase()),a=a+r+l}}return{tagList:n,tagDisplay:a='<span class="event-detail event-tags" aria-label="'+t.get("Event category")+'"><img data-toggle="tooltip" title="'+t.get("Event category")+'" data-placement="top" alt="" src="'+v+'tags.svg" class="fa-svg event-details-icon">'+a+"</span>"}}(e.tags),p=s.tagDisplay,o=s.tagList);var u=function(e,a){var n=e.substr(0,10),i=e.slice(-5);"00.00"===i&&(i=null);var s=null,o=null;null!==a&&""!==a&&(s=a.substr(0,10),"00.00"!=a.slice(-5)&&(o=a.slice(-5)));var l=!0;null!==s&&s!=n&&(l=!1);var r=!1,c='<img alt="" src="'+v+'calendar.svg" class="fa-svg event-details-icon"> '+n;null!=i&&(c=c+'<img alt="" src="'+v+'clock.svg" class="fa-svg event-details-icon event-li-clock"> '+i);var d="";null!=s?l&&null!=o?d=o:l&&null==o?(d="",c+=t.get("Starting")):l||null!=o?l||null==o||(d=(d='<img alt="" src="'+v+'calendar.svg" class="fa-svg event-details-icon"> '+s)+'<img alt="" src="'+v+'clock.svg" class="fa-svg event-details-icon event-li-clock"> '+o,r=!0):d=s:c+=t.get("Starting");var g="";return""!==d&&(g='<i class="start-end-divider"> – </i>'),r&&(c='<span class="event-time-row event-start-row">'+c+g+"</span>",d='<span class="event-time-row event-end-row">'+d+"</span>",g=""),'<div class="event-date-container">'+c+g+d+"</div>"}(e.start_date,e.end_date),h="";0==e.image&&(e.image="https://keski-finna.fi/wp-content/uploads/paakirjasto59_YouTube_820x461_acf_cropped.jpg"),null!==e.image&&!1!==e.image&&(h='<img class="event-image" loading="lazy" alt="" src="'+e.image+'">');var y=e.title;i&&null!==e.english_title&&""!=e.english_title&&(y=e.english_title);var k=e.content;i&&null!==e.english_content&&""!=e.english_content&&(k=e.english_content);d="";var b="",w=[];if(e.custom_address){var x=e.custom_address,_=x.street_name,S=x.street_number,z=x.post_code,E=x.city;null==E&&(E=x.state),g.push(E);var O=x.name;if(null==O)O="";else O.slice(0,4)==_.slice(0,4)&&(O=O+", "+E);b=O;var L={lat:x.lat,lon:x.lng},T=_+" "+S;null==S&&(T=_);var N={street:T,zipcode:z};w.push({location:O,coordinates:L,city:E,address:N})}for(var C=0;C<e.organizer.length;C++){for(var D=!1,I=0;I<c.length;I++)if(e.organizer[C]==c[I].id){T=c[I].street;var j=c[I].zipcode,J=c[I].city,W={street:T,zipcode:j};e.organizer[C]={location:c[I].text,coordinates:c[I].coordinates,city:J,address:W},g.push(c[I].city),D=!0}D||(0==e.organizer[C]?(e.organizer[C]={location:t.get("Other location"),coordinates:null,city:null},g.push(t.get("Other location"))):1==e.organizer[C]?(e.organizer[C]={location:t.get("Keski Libraries"),coordinates:null,city:null},g.push(t.get("Keski Libraries"))):2==e.organizer[C]&&(e.organizer[C]={location:t.get("Web event"),coordinates:null,city:null},g.push(t.get("Web event"))))}d=e.organizer.length>1?e.organizer.length+" "+t.get("event locations"):void 0!==e.organizer[0]?e.organizer[0].location:t.get("Other location"),""!=e.price&&(r=e.price+" €",r='<span class="event-detail event-price" aria-label="'+t.get("Price")+'"><img data-toggle="tooltip" title="'+t.get("Price")+'" data-placement="top" alt="" src="'+v+'money-bill-alt.svg" class="fa-svg event-details-icon">'+r+"</span>");var F="";if(null!==e.link_url&&""!=e.link_url){var M=generatePrettyUrl(e.link_url);F='<span class="event-detail event-link" aria-label="'+t.get("Website")+'"><img data-toggle="tooltip" title="'+t.get("Website")+'" data-placement="top" alt="" src="'+v+'globe.svg" class="fa-svg event-details-icon"><a href="'+e.link_url+'">'+M+"</a></span>"}var P=e.organizer;""!==b&&(d=b,P=w);var R="";if(1==P.length){var Y=P[0];null!=Y.address&&null!=Y.city&&null!=Y.coordinates&&(R=function(e,a,n,s,o){var l=a+", "+s+"::"+e.lat+", "+e.lon,r=t.get("Route and transportation");return l="https://opas.matka.fi/reitti/POS/"+l,l=encodeURI(l),"Jyväskylä"!==s&&(l="https://www.google.com",i||(l="https://www.google.fi"),l=(l+="/maps/dir//")+a+", "+n+", "+s+"/@"+e.lat+", "+e.lon+", 15z/",r=t.get("Navigation to location")),'<a target="_blank" class="external-navigation-link" href="'+l+'">'+r+"</a>"}(Y.coordinates,Y.address.street,Y.address.zipcode,Y.city))}""!=R&&(R='<span class="event-detail event-transit" aria-label="'+t.get("Navigation to location")+'"><img data-toggle="tooltip" title="'+t.get("Navigation to location")+'" data-placement="top" alt="" src="'+v+'directions.svg" class="fa-svg event-details-icon">'+R+"</span>");var A="",Q="";""!=e.location_info&&null!=e.location_info&&""==Q&&"."!=(Q=e.location_info).charAt(Q.length-1)&&(Q+="."),""!==Q&&(A='<span class="event-detail event-location-info" aria-label="'+t.get("Location information")+'"><img data-toggle="tooltip" title="'+t.get("Location information")+'" data-placement="top" alt="" src="'+v+'location-arrow.svg" class="fa-svg event-details-icon">'+Q+"</span>"),k='<div class="event-content"><div class="event-modal-description">'+k+'<div class="event-info-box">'+p+r+F+"</div></div></div>";var V="";n&&(V="front-page-event"),P=JSON.stringify(P);var H='<li class="event-li '+V+'" id="event-'+a+'"><a class="event-item-link" href="javascript:void(0);"data-url=\''+e.perma_link+"' data-image='"+h+"' data-name='"+y+"' data-time='"+u+"' data-message='"+k+"' data-location-text='"+d+"' data-location='"+P+"' data-location-info='"+A+"' data-transit='"+R+'\'><div class="event-li-img" style="height: 100%; width: auto;">'+h+'</div><div class="event-li-details"><span class="event-li-title">'+y+"</span>"+u+'<span class="event-li-place"><img alt="" src="'+v+'map-marker-alt.svg" class="fa-svg event-li-icon">'+d+"</span></div></a></li>";$("#keskiEventsUl").append(H),g=$.unique(g);for(var U=0;U<g.length;U++)m(g[U]);l.push({id:a,tags:o,city:g,url:e.perma_link}),isFrontPage||$(".events-section-title").replaceWith('<h1 class="events-page-title events-section-title">'+t.get("Events")+' <span class="events-count-small"> ('+l.length+")</span></h1>")}function x(e){var t=e.substr(0,10),a=e.slice(-5),n=t.substr(0,2),i=t.substr(3,2),s=t.substr(6,4),o=a.substr(0,2),l=a.substr(3,2),r=new Date;return r.setDate(n),r.setMonth(i-1),r.setYear(s),r.setHours(o),r.setMinutes(l),r.setSeconds(0),r}function _(){i?s.sort((function(e,t){return e.nameEn.localeCompare(t.nameEn)})):s.sort((function(e,t){return e.nameFi.localeCompare(t.nameFi,"fi",{sensitivity:"base"})}));for(var t=0;t<s.length;t++){var a=s[t].id,n=s[t].nameFi;i&&(n=s[t].nameEn),$("#categoryFiltersContent").append('<div id="tag_'+a+'" class="tag-checkbox-container"><label class="'+e+'"><input type="checkbox" name="tags" value="'+a+'"><span>'+n+"</span></label></div>")}o.sort((function(e,t){return e.id.localeCompare(t.id,"fi",{sensitivity:"base"})}));for(var l=0;l<o.length;l++){var r=o[l].id;$("#locationFiltersContent").append('<div id="location_'+r+'" class="location-checkbox-container"><label class="'+e+'"><input id="'+r+'" type="checkbox" name="location" value="'+r+'"><span>'+r+"</span></label></div>")}if($('input[name="tags"]').change((function(){h=[],$.each($("input[name='tags']:checked"),(function(){h.push(parseInt($(this).val()))})),k(!0)})),$('input[name="location"]').change((function(){y=[],$.each($("input[name='location']:checked"),(function(){y.push($(this).val())})),k()})),window.innerWidth>800&&$("#toggleEventFilters").click(),$("#keskiEvents .loader").css("display","none"),window.innerWidth>800){var c=$(".event-location-filter").innerHeight()+$(".event-category-filter").innerHeight()+500;$(".event-filters").css("margin-bottom",c+"px"),$(".event-filters .collapsed").click(),$(".events-page").css("min-height",c+"px")}$(".event-filters").css("visibility","visible")}function S(){$(".event-item-link").on("click",(function(e){var a=$(this).data("name"),n=$(this).data("time"),i=$(this).data("message"),s=$(this).data("location-text"),o=$(this).data("location"),l=$(this).data("location-info"),r=$(this).data("transit"),c=$(this).data("image");i=(i=(i=(i=i.replace(/^(&nbsp;)+/g,"")).replace(/(<p>&nbsp;<\/p>)+/g,"")).replace(/(<p><\/p>)+/g,"")).replace(/(<p>\s<\/p>)+/g,"");var d,g,p='<div class="event-info-box event-location-info-box">'+('<span class="event-detail event-location" aria-label="Location"><img data-toggle="tooltip" title="'+t.get("Location")+'" data-placement="top" alt="" src="'+v+'map-marker-alt.svg" class="fa-svg event-details-icon">'+s+"</span>")+l+r+"</div>";$(".event-modal-header-text").replaceWith('<div class="event-modal-header-text"><h1 class="modal-title" id="eventModalTitle">'+a+"</h1>"+n+"</div>"),$("#eventDescription").replaceWith('<div id="eventDescription"><div> <div class="feed-content"><div class="holder">'+i+"</div></div></div></div>"),$("#mapRow").css("display","block"),$(".event-location-info-box").replaceWith(p),d=o,g=jQuery.Deferred(),setTimeout((function(){z?T.clearLayers():(z=L.map("eventMapContainer"),L.tileLayer.fallback("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(z),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png").addTo(z),z.options.minZoom=6,z.options.maxZoom=18,z.setView(["62.750","25.700"],10.5),T=L.layerGroup().addTo(z),$(".leaflet-control-attribution").replaceWith('<div class="leaflet-control-attribution leaflet-control">© <a target="_blank" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | <a target="_blank" href="https://carto.com/attributions">CARTO</a></div>')),$.when(function(e){var t=jQuery.Deferred();return setTimeout((function(){if(0!==e.length)for(var a=null,n=0,i=0;i<e.length;i++){if(null==e[i].coordinates){if(1==e.length)return $("#mapRow").css("display","none"),void t.resolve();n+=1}else N(e[i]),n+=1;if(n===e.length)try{a=null==e[i].coordinates?{lat:e[i-1].coordinates.lat,lon:e[i-1].coordinates.lon}:{lat:e[i].coordinates.lat,lon:e[i].coordinates.lon},z.whenReady((function(){setTimeout((function(){z.invalidateSize();var t=12;e.length>1&&(t=9.5),z.setView([a.lat,a.lon],t),T.eachLayer((function(e){e.openPopup()}))}),250)})),t.resolve()}catch(e){console.log(e),$("#mapRow").css("display","none"),t.resolve()}}}),1),t.promise()}(d)).then((function(){g.resolve()}))}),1),g.promise(),$("#eventImageContainer").html('<div id="eventImageContainer">'+c+"</div>"),$("#eventModal").modal("show");var u=$(this).data("url").toString(),f=window.location.href.toString();if(-1===f.indexOf(u)){var m={urlValue:u=f+"?event="+u};history.replaceState(m,a,u)}}));var e=window.location.href;if((e=decodeVal(e)).indexOf("?event=")>-1)for(var a=new RegExp(/\?event=.*/g),n=e.match(a)[0],i=0;i<l.length;i++){if(n==="?event="+l[i].url){var s=l[i].url;setTimeout((function(){$('[data-url="'+s+'"]').click()}),1400)}}$("#eventModal").on("hide.bs.modal",(function(){var e=window.location.href;if(e.indexOf("?event=")){var t=new RegExp(/\?event=.*/g),a={urlValue:e=e.replace(t,"")};history.replaceState(a,"",e)}}))}var z,E=!1;function O(e){if(!E){E=!0,e.sort((function(e,t){return x(e.acf.start_date)-x(t.acf.start_date)}));var t=e.length;n&&(t=4,window.innerWidth>767&&(t=6));for(var a=0;a<t;a++)if(t!==e.length){var i=e[a].acf.start_date,s=(i=moment(i,"DD.MM.YYYY"))._d;s.setDate(s.getDate()+2),s<new Date?t+=1:w(e[a].acf,e[a].id)}else w(e[a].acf,e[a].id);S(),_()}}var T=null;function N(e){var a,n="",i="",s=e.location;null!=e.address?(null!=e.address.street&&(n=e.address.street),null!=e.address.zipcode&&(i=e.address.zipcode),s=s.indexOf(e.address.street)>-1?"":"<strong>"+e.location+"</strong><br>"):s="<strong>"+e.location+"</strong><br>",a=s+n+", <br>"+i+", "+e.city;var o=L.divIcon({html:'<img data-toggle="tooltip" title="'+t.get("Event location")+'" alt="" src="'+v+'book-reader.svg" class="fa-svg fa-leaflet-map-marker">',iconSize:[24,24],popupAnchor:[0,3],className:"event-map-marker"});null!=e.coordinates&&L.marker([e.coordinates.lat,e.coordinates.lon],{icon:o}).addTo(T).bindPopup(a,{autoClose:!1,autoPan:!1}).openPopup()}function C(e){var t=jQuery.Deferred();return setTimeout((function(){try{for(var a=0,n=0;n<e.items.length;n++){for(var i=0;i<c.length;i++)c[i].city==e.items[n].id.toString()&&(c[i].city=e.items[n].name);(a+=1)===e.items.length&&(c.sort((function(e,t){return e.city<t.city?-1:e.city>t.city?1:0})),t.resolve())}}catch(e){console.log("Error in fetching cities: "+e)}}),1),t.promise()}$(document).ready((function(){var e,s;"en-gb"==document.documentElement.lang&&(i=!0),a=1===$(".events-page").length,n=1===$(".events-front-page").length,(a||n)&&$.when((e=2113,s=jQuery.Deferred(),setTimeout((function(){null!==g&&(c=JSON.parse(g),s.resolve()),$.getJSON("https://api.kirjastot.fi/v4/library?lang=fi&consortium="+e+"&limit=1500",(function(e){for(var t=0;t<e.items.length;t++)c.push({id:e.items[t].id,text:e.items[t].name,city:e.items[t].city.toString(),street:e.items[t].address.street,zipcode:e.items[t].address.zipcode,coordinates:e.items[t].coordinates,services:JSON.stringify(e.items[t].services)}),85449==e.items[t].id&&c.push({id:e.items[t].id,text:e.items[t].name,city:"16055",street:e.items[t].address.street,zipcode:e.items[t].address.zipcode,coordinates:e.items[t].coordinates,services:JSON.stringify(e.items[t].services)});localStorage.setItem("keskiLibraries",JSON.stringify(c)),s.resolve()}))}),1),s.promise())).then((function(){var e;$.when((e=jQuery.Deferred(),setTimeout((function(){try{null!==p?(C(JSON.parse(p)),e.resolve()):$.getJSON("https://api.kirjastot.fi/v4/city?lang=fi&limit=1500",(function(t){localStorage.setItem("cityList",JSON.stringify(t)),C(t),e.resolve()}))}catch(e){console.log("Error in fetching cities: "+e)}}),1),e.promise())).then((function(){null===d?b():u(),n?($(".events-section-title").text(t.get("Events")),$(".events-front-page-nav-button").text(t.get("More events")),$(".events-front-page-nav-button").css("visibility","visible")):($(".no-matching-events-div").text(t.get("No matching events")),$(".sr-event-filters-title").text(t.get("Filter events")),$("#toggleEventFilters").text(t.get("Filter events")),$(".event-category-filter-title").text(t.get("Category")),$(".event-location-filter-title").text(t.get("Location"))),$(".close-event-modal").text(t.get("Close"))}))}))}));
